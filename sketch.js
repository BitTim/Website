var mapdat = [
	'#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#',
	'#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
	'#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', '#', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', '#', '#', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', '#', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', '#', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', '#', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', '#', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', '#', '#', '#', ' ', ' ', ' ', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', ' ', ' ', ' ', '#', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', '#', '#', '#', '#', ' ', '#', '#', '#', ' ', ' ', ' ', '#', '#', '#', '#', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', '#', '#', '#', '#', ' ', '#', '#', '#', ' ', ' ', ' ', ' ', ' ', '#', '#', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', '#', '#', '#', '#', ' ', ' ', ' ', '#', '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', '#', '#', ' ', ' ', ' ', '#', '#', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', '#', '#', '#', '#', '#', '#', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', '#', '#', ' ', ' ', ' ', '#',
  '#', ' ', '#', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', '#', '#', ' ', ' ', ' ', '#',
  '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '#',
  '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'
];

const SCREEN_WIDTH = 640, SCREEN_HEIGHT = 480;
const map_width = 32, map_height = 32;
const spawn_x = 2, spawn_y = 1;
const depth = 16;
const speed = 0.125;
const scale = 8;
const bullet_speed = 1;
const lamp_count = 10;

var file_reader = new FileReader();

var debug = false;
var depth_buffer = [];
var objects = [];

var lamp_palette;
var bullet_palette;

var lamp_img = [
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
  0, 0, 0, 1, 0, 0, 0, 3, 3, 0, 0, 0, 1, 0, 0, 0,
  0, 0, 0, 1, 0, 0, 3, 4, 4, 3, 0, 0, 1, 0, 0, 0,
  0, 0, 0, 0, 1, 0, 3, 4, 4, 3, 0, 1, 0, 0, 0, 0,
  0, 0, 0, 0, 1, 0, 0, 3, 3, 0, 0, 1, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 1, 0, 3, 3, 0, 1, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 1, 0, 2, 2, 0, 1, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
  0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0,
];

var bullet_img = [
  0, 0, 1, 1, 1, 1, 0, 0,
  0, 1, 1, 1, 1, 1, 1, 0,
  1, 1, 1, 2, 2, 1, 1, 1,
  1, 1, 2, 2, 2, 2, 1, 1,
  1, 1, 2, 2, 2, 2, 1, 1,
  1, 1, 1, 2, 2, 1, 1, 1,
  0, 1, 1, 1, 1, 1, 1, 0,
  0, 0, 1, 1, 1, 1, 0, 0,
];

var fov = 3.14159 / 3.0;
var x = spawn_x, y = spawn_y, a = 0.0;

var tp1, tp2;
var elapsed_time = 0;

var bullet;
var lamp;

var bullet_x = 0, bullet_y = 0;

function setup() {
  var canvas = createCanvas(SCREEN_WIDTH + SCREEN_HEIGHT, SCREEN_HEIGHT);
	frameRate(30);

	canvas.parent('game');

  tp1 = millis();
	tp2 = millis();
  
  lamp_palette = [
    color(0, 0, 0, 0), color(150, 50, 50, 255), color(150, 150, 150, 255), color(255, 238, 0, 255), color(255, 200, 0, 255)
  ];
  
  bullet_palette = [
    color(0, 0, 0, 0), color(255, 200, 0, 255), color(255, 238, 0, 255)
  ];
  
  bullet = createImage(8, 8);
  bullet.loadPixels();
  
  for(var j = 0; j < 8; j++)
  {
    for(var i = 0; i < 8; i++)
    {
      bullet.set(i, j, bullet_palette[bullet_img[j * 8 + i]]);
    }
  }
  
  bullet.updatePixels();
  
  lamp = createImage(16, 64);
  lamp.loadPixels();
  
  for(var j = 0; j < 64; j++)
  {
    for(var i = 0; i < 16; i++)
    {
      lamp.set(i, j, lamp_palette[lamp_img[j * 16 + i]]);
    }
  }
  
  canvas.drawingContext.imageSmoothingEnabled = false
  lamp.updatePixels();
  
  for(var i = 0; i < lamp_count; i++)
  {
    var lx = Math.floor(Math.random() * 30) + 1;
    var ly = Math.floor(Math.random() * 30) + 1;
    
    while(!(mapdat[ly * map_width + lx] === ' '))
    {
      lx = Math.floor(Math.random() * 30) + 1;
      ly = Math.floor(Math.random() * 30) + 1;
    }
   
    objects.push({
      x: lx,
      y: ly,
      width: 16,
      height: 64,
      color: [86, 234, 245],
      type: "lamp",
      remove: false
    });
  }
}

function keyPressed()
{
  if(keyCode === ALT)
  {
    if(debug)
    {
      debug = false;
    }
    else
    {
      debug = true;
    }
  }
  
  if(key === ' ')
	{
		objects.push({
      x: x,
      y: y,
      width: 8,
      height: 8,
      color: [255, 0, 0],
      type: "bullet",
      remove: false
    });
	}
  
  if(key === 'f')
  {
    fov = 3.14159 / 3.0;
  }
}

function draw() {
  if(keyIsPressed && keyCode === UP_ARROW)
  {
    fov += 0.1;
  }
  
  if(keyIsPressed & keyCode === DOWN_ARROW)
  {
    fov -= 0.1;
  }
  
	if(keyIsPressed && key === 'a')
	{
		a -= (0.1);
	}

	if(keyIsPressed && key === 'd')
	{
		a += (0.1);
	}

	if(keyIsPressed && key === 'w')
	{
		x += sin(a) * speed;
		y += cos(a) * speed;
    
		if (mapdat[floor(y) * map_width + floor(x)] === '#' || x < 0 || x > map_width || y < 0 || y > map_height)
		{
			x -= sin(a) * speed;
			y -= cos(a) * speed;
		}
	}

	if(keyIsPressed && key === 's')
	{
		x -= sin(a) * speed;
		y -= cos(a) * speed;

		if (mapdat[floor(y) * map_width + floor(x)] === '#' || x < 0 || x > map_width || y < 0 || y > map_height)
		{
			x += sin(a) * speed;
			y += cos(a) * speed;
		}
	}
  
  if(keyIsPressed && key === 'q')
	{
		x -= cos(a) * speed;
		y += sin(a) * speed;
    
		if (mapdat[floor(y) * map_width + floor(x)] === '#' || x < 0 || x > map_width || y < 0 || y > map_height)
		{
			x += cos(a) * speed;
			y -= sin(a) * speed;
		}
	}
  
  if(keyIsPressed && key === 'e')
	{
		x += cos(a) * speed;
		y -= sin(a) * speed;
    
		if (mapdat[floor(y) * map_width + floor(x)] === '#' || x < 0 || x > map_width || y < 0 || y > map_height)
		{
			x -= cos(a) * speed;
			y += sin(a) * speed;
		}
	}

  tp2 = millis();
	elapsed_time = tp2 - tp1;
	tp1 = tp2;
  
  var k = map_height - 1;
  for(var j = 0; j < map_height; j++, k--)
  {
    for(var i = 0; i < map_width; i++)
    {
      noStroke();
      if(mapdat[k * map_width + i] === ' ')
      {
        fill(63);
        rect(SCREEN_WIDTH + i * (SCREEN_HEIGHT / map_width), j * (SCREEN_HEIGHT / map_height), SCREEN_HEIGHT / map_width, SCREEN_HEIGHT / map_height);
      }
    }
  }

	for(var i = 0; i < SCREEN_WIDTH; i += scale)
	{
		var work_angle = (a - fov / 2) + (i / SCREEN_WIDTH) * fov;
    
    var eye_x = sin(work_angle);
		var eye_y = cos(work_angle);

		var step = 0.1;
		var wall_dist = 0.0;
    
    var wall_hit = false;
    
		while(!wall_hit && wall_dist < depth)
		{
			wall_dist += step;

			var test_x = floor(x + eye_x * wall_dist);
			var test_y = floor(y + eye_y * wall_dist);

			if(test_x < 0 || test_x > map_width || y < 0 || y > map_height)
			{
				wall_hit = true;
				wall_dist = depth;
			}
			else
			{
				if(mapdat[test_y * map_width + test_x] === '#')
				{
					wall_hit = true;
				}
			}
		}
    
    wall_dist *= abs(cos(work_angle - a));
    
    stroke(175, 255, 100);
    line(SCREEN_WIDTH + x * (SCREEN_HEIGHT / map_width), (map_height - y) * (SCREEN_HEIGHT / map_height), SCREEN_WIDTH + (x + eye_x * wall_dist) * (SCREEN_HEIGHT / map_width), (map_height - (y + eye_y * wall_dist)) * (SCREEN_HEIGHT / map_height));
    noStroke();
    
    for(var j = 0; j < scale; j++)
    {
      depth_buffer[i + j] = wall_dist;
    }
      
		var map_ceiling = (SCREEN_HEIGHT / 2.0) - (SCREEN_HEIGHT / wall_dist);
		var map_floor = SCREEN_HEIGHT - map_ceiling;

		var shade = 0;
    var cShade = [0, 0, 0];

		if(wall_dist <= depth / 6)
		{
			shade = 255;
		}
		else if(wall_dist < depth / 5)
		{
			shade = 217;
		}
		else if(wall_dist < depth / 4)
		{
			shade = 179;
		}
		else if(wall_dist < depth / 3)
		{
			shade = 141;
		}
    else if(wall_dist < depth / 2)
    {
      shade = 103
    }
		else
		{
			shade = 65;
		}

		for(var j = 0; j < SCREEN_HEIGHT; j += scale)
		{
			if(j < map_ceiling)
			{
				/*stroke*/ /*fill(149, 238, 249);*/ fill(0, 50, 55);
				//point(i, j);
        rect(i, j, scale, scale);
			}
			else if(j > map_ceiling && j <= map_floor)
			{
				/*stroke*/ fill(shade);
				//point(i, j);
        rect(i, j, scale, scale)
			}
			else
			{
				var b = 1.0 - (j - SCREEN_HEIGHT / 2.0) / (SCREEN_HEIGHT / 2.0);

				if (b < 0.25)
				{
					shade = [0, 128, 0];
				}
				else if (b < 0.5)
				{
					shade = [0, 99, 0];
				}
				else if (b < 0.75)
				{
					shade = [0, 70, 0];
				}
				else if (b < 0.9)
				{
					shade = [0, 41, 0];
				}
				else
				{
					shade = [63, 63, 63];
				}

				/*stroke*/ fill(shade[0], shade[1], shade[2]);
				//point(i, j);
        rect(i, j, scale, scale);
			}
		}
	}
  
  var k = map_height - 1;
  for(var j = 0; j < map_height; j++, k--)
  {
    for(var i = 0; i < map_width; i++)
    {
      noStroke();
      if(mapdat[k * map_width + i] === '#')
      {
        fill(252, 63, 63);
        rect(SCREEN_WIDTH + i * (SCREEN_HEIGHT / map_width), j * (SCREEN_HEIGHT / map_height), SCREEN_HEIGHT / map_width, SCREEN_HEIGHT / map_height);
      }
    }
  }
  
  objects.forEach(function(object)
  {
    if(mapdat[floor(object.y) * map_width + floor(object.x)] === '#')
    {
      object.remove = true;
    }
    
    var vec_x = object.x - x;
    var vec_y = object.y - y;
    
    var object_dist = sqrt(sq(vec_x) + sq(vec_y));
    
    var eye_x = sin(a);
    var eye_y = cos(a);
    
    var object_a = atan2(eye_y, eye_x) - atan2(vec_y, vec_x);
    if(object_a < -3.24259)
    {
      object_a += 2 * 3.14159;
    }
    
    if(object_a > 3.14159)
    {
      object_a -= 2 * 3.14159;
    }
    
    if(object.type === "bullet" && object.x >= 0 && object.y >= 0 && object.x < x + depth && object.y < y + depth && mapdat[floor(object.y) * map_width + floor(object.x)] != '#')
    {
      object.x += sin(a) * bullet_speed;
      object.y += cos(a) * bullet_speed;
      
      fill(255, 238, 0);
    }
    else if(object.type === "bullet" && (object.x < 0 || object.y < 0 || object.x >= x + depth || object.y >= y + depth || mapdat[floor(object.y) * map_width + floor(object.x)] === '#'))
    {
      object.remove = true;
    }
    else
    {
      fill(0, 238, 255);
    }
    
    rect(SCREEN_WIDTH + object.x * (SCREEN_HEIGHT / map_width), SCREEN_HEIGHT - object.y * (SCREEN_HEIGHT / map_height), SCREEN_HEIGHT / map_width, SCREEN_HEIGHT / map_height);
    
    var in_fov = abs(object_a) < (fov / 2) ? true : false;
    
    if(in_fov && object_dist >= 0.5 && object_dist < depth && !object.remove)
    {
      var object_ceiling = (SCREEN_HEIGHT / 2) - (SCREEN_HEIGHT / object_dist);
      var object_floor = SCREEN_HEIGHT - object_ceiling;
      
      var object_height = object_floor - object_ceiling;
      var object_aspect = object.height / object.width;
      var object_width = object_height / object_aspect;
      
      var object_middle = (0.5 * (object_a / (fov / 2.0)) + 0.5) * (SCREEN_WIDTH);
      
			for(var lx = 0; lx < object_width; lx++)
			{
				for(var ly = 0; ly < object_height; ly++)
				{
					var sample_x = lx / object_width;
					var sample_y = ly / object_height;

					var object_column = object_middle + lx - (object_width / 2.0);
          
          if(object.type === "lamp")
          {
            lamp.loadPixels();
          }
          else if(object.type === "bullet")
          {
            bullet.loadPixels();
          }
            
					if (object_column >= 0 && object_column < SCREEN_WIDTH)
          { 
            if(object_column + lx * (object_width / object.width) < SCREEN_WIDTH && object_ceiling + ly * (object_height / object.height) < SCREEN_HEIGHT)
            {
              if (depth_buffer[floor(object_column)] >= object_dist)
              {	
                if(object.type === "lamp")
                {
                  //fill(lamp.get(lx / (object_width / object.width), ly / (object_height / object.height), 1, 1)[0], lamp.get(lx / (object_width / object.width), ly / (object_height / object.height), 1, 1)[1], lamp.get(lx / (object_width / object.width), ly / (object_height / object.height), 1, 1)[2], lamp.get(lx / (object_width / object.width), ly / (object_height / object.height), 1, 1)[3]);
                  fill(lamp.get(sample_x * object.width, sample_y * object.height, 1, 1)[0], lamp.get(sample_x * object.width, sample_y * object.height, 1, 1)[1], lamp.get(sample_x * object.width, sample_y * object.height, 1, 1)[2], lamp.get(sample_x * object.width, sample_y * object.height, 1, 1)[3]);
                  rect(object_column + lx * (object_width / object.width), object_ceiling + ly * (object_height / object.height), (object_height / object.height) + 2, (object_height / object.height) + 2);
                }
                else if(object.type === "bullet")
                {
                  fill(bullet.get(sample_x * object.width, sample_y * object.height, 1, 1)[0], bullet.get(sample_x * object.width, sample_y * object.height, 1, 1)[1], bullet.get(sample_x * object.width, sample_y * object.height, 1, 1)[2], bullet.get(sample_x * object.width, sample_y * object.height, 1, 1)[3]);
                  rect(object_column + lx * (object_width / object.width), object_ceiling + ly * (object_height / object.height), (object_height / object.height) + 2, (object_height / object.height) + 2);
                }
                else
                {
                  fill(object.color[0], object.color[1], object.color[2]);
                  rect(object_column, (object_ceiling + ly), scale, scale);
                }
                
                depth_buffer[floor(object_column)] = object_dist;
              }
            }
					}
				}
      }
    }
    
    if(object.remove)
    {
      objects.splice(objects.indexOf(object), 1);
    }
  });
  
  if(debug)
  {
    fill(255, 255, 255);
    textSize(20);
    text('X:', SCREEN_WIDTH + 10, SCREEN_HEIGHT - 7.5);
    text(Math.round(x * 100) / 100, SCREEN_WIDTH + 30, SCREEN_HEIGHT - 7.5);
    
    text('Y:', SCREEN_WIDTH + 110, SCREEN_HEIGHT - 7.5);
    text(Math.round(y * 100) / 100, SCREEN_WIDTH + 130, SCREEN_HEIGHT - 7.5);
    
    text('A:', SCREEN_WIDTH + 210, SCREEN_HEIGHT - 7.5);
    text(Math.round(a * 100) / 100, SCREEN_WIDTH + 230, SCREEN_HEIGHT - 7.5);
  }
  
  fill(63, 144, 252);

  translate(SCREEN_WIDTH + x * (SCREEN_HEIGHT / map_width) + (SCREEN_HEIGHT / map_width / 2), (map_height - 1 - y) * (SCREEN_HEIGHT / map_height) + (SCREEN_HEIGHT / map_height / 2));
  rotate(a);
  
  rect(-(SCREEN_HEIGHT / map_width / 2), -(SCREEN_HEIGHT / map_width / 2), SCREEN_HEIGHT / map_width, SCREEN_HEIGHT / map_height);
  
  fill(255, 191, 128);
	rect(-(SCREEN_HEIGHT / map_width) / 4, -(SCREEN_HEIGHT / map_height) / 2, (SCREEN_HEIGHT / map_width) / 2, (SCREEN_HEIGHT / map_height) / 2);
  
  rotate(-a);
  translate(-(SCREEN_WIDTH + x * (SCREEN_HEIGHT / map_width) + (SCREEN_HEIGHT / map_width / 2)), -(y * (SCREEN_HEIGHT / map_height) + (SCREEN_HEIGHT / map_height / 2))); //Faulty
}
